# Development Dockerfile
# Builds an image that fetches the backend and frontend sources from their
# GitHub repositories. Use build args BACKEND_REF and FRONTEND_REF to pick
# branches/tags/commits (defaults to 'main').

FROM alpine:3.18.3 as fetch

ARG BACKEND_REF=master
ARG FRONTEND_REF=master

RUN apk --no-cache add ca-certificates git curl tar bash nodejs npm yarn shadow unzip \
    php81 php81-cli php81-ctype php81-tokenizer php81-iconv php81-mbstring php81-xml php81-json php81-dom php81-pdo_mysql php81-fpm php81-session php81-sqlite3 php81-pdo_sqlite composer

WORKDIR /source

# Clone backend and frontend
RUN git clone --depth 1 --branch ${BACKEND_REF} https://github.com/strichliste/strichliste-backend.git backend || (echo "Failed to clone backend" && exit 1)
RUN git clone --depth 1 --branch ${FRONTEND_REF} https://github.com/strichliste/strichliste-web-frontend.git frontend || (echo "Failed to clone frontend" && exit 1)

# Install backend PHP dependencies (composer)
WORKDIR /source/backend
RUN if [ -f composer.json ]; then composer install --no-interaction --no-dev --prefer-dist --optimize-autoloader; fi

# Build frontend (yarn/npm)
WORKDIR /source/frontend
RUN if [ -f package.json ]; then yarn install --frozen-lockfile --non-interactive || npm install --no-audit --no-fund; fi
RUN if [ -f package.json ] && ( [ -f yarn.lock ] || [ -f package-lock.json ] ); then NODE_OPTIONS=--openssl-legacy-provider yarn build || NODE_OPTIONS=--openssl-legacy-provider npm run build; fi

# Ensure a build directory exists (some frontends write to `build`, others to `dist`),
# create an empty build dir if not present to avoid later COPY failures.
RUN [ -d /source/frontend/build ] || mkdir -p /source/frontend/build

FROM alpine:3.18.3

RUN apk --no-cache add ca-certificates \
  && apk --no-cache add \
    curl \
    php81 \
    php81-ctype \
    php81-tokenizer \
    php81-iconv \
    php81-mbstring \
    php81-xml \
    php81-json \
    php81-dom \
    php81-pdo_mysql \
    php81-fpm \
    php81-session \
    php81-sqlite3 \
    php81-pdo_sqlite \
    nginx \
    bash \
    mysql-client \
    yarn \
    git

COPY --from=fetch /source/backend /source
COPY --from=fetch /source/frontend /source/frontend

# If the frontend produced a build, copy it into the backend public directory so
# static files are served from /source/public.
COPY --from=fetch /source/frontend/build /source/public

COPY entrypoint.sh /source/entrypoint.sh
RUN chmod +x /source/entrypoint.sh

RUN adduser -u 82 -D -S -G www-data www-data
RUN chown -R www-data:www-data /source
RUN chown -R www-data:www-data /var/lib/nginx
RUN chown -R www-data:www-data /var/log/nginx
RUN chown -R www-data:www-data /var/log/php81

USER www-data

COPY ./config/php-fpm.conf /etc/php81/php-fpm.conf
COPY ./config/www.conf /etc/php81/php-fpm.d/www.conf
COPY ./config/nginx.conf /etc/nginx/nginx.conf
COPY ./config/default.conf /etc/nginx/conf.d/default.conf

VOLUME /source/var

WORKDIR /source/public
EXPOSE 8080

ENTRYPOINT ["/source/entrypoint.sh"]
